<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinto - Resultados</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
        }

        .fase-info {
            font-size: 20px;
            color: #666;
            margin-bottom: 20px;
        }

        .comparacion {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .imagen-box {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 15px;
        }

        .imagen-box h3 {
            margin-bottom: 10px;
            color: #555;
        }

        .imagen-box img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .imagen-box.original {
            border: 3px solid #27ae60;
        }

        .imagen-box.dibujo.rojo {
            border: 3px solid #e74c3c;
        }

        .imagen-box.dibujo.azul {
            border: 3px solid #3498db;
        }

        .equipo-label {
            font-size: 22px;
            font-weight: bold;
            margin: 15px 0;
        }

        .equipo-rojo {
            color: #e74c3c;
        }

        .equipo-azul {
            color: #3498db;
        }

        .votacion {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        .btn-voto {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transition: all 0.2s;
        }

        .btn-voto:hover {
            transform: scale(1.1);
        }

        .btn-voto.seleccionado {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            transform: scale(1.2);
        }

        .esperando {
            padding: 20px;
            background: #fff3cd;
            color: #856404;
            border-radius: 10px;
            margin: 20px 0;
        }

        .resultado-final {
            display: none;
        }

        .resultado-final.visible {
            display: block;
        }

        .puntajes {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin: 30px 0;
        }

        .puntaje-equipo {
            padding: 30px 50px;
            border-radius: 15px;
            font-size: 24px;
        }

        .puntaje-equipo.rojo {
            background: linear-gradient(135deg, #ffe0e0, #ffcccc);
            border: 3px solid #e74c3c;
        }

        .puntaje-equipo.azul {
            background: linear-gradient(135deg, #e0e8ff, #ccd9ff);
            border: 3px solid #3498db;
        }

        .puntaje-numero {
            font-size: 48px;
            font-weight: bold;
        }

        .ganador-banner {
            font-size: 36px;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            color: white;
        }

        .ganador-banner.rojo {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        .ganador-banner.azul {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }

        .ganador-banner.empate {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
        }

        .btn-volver {
            padding: 15px 40px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Pantalla de votaci√≥n -->
        <div id="pantallaVotacion">
            <h1>üé® ¬°Hora de votar!</h1>

            <div class="fase-info" id="faseInfo">
                Votando el dibujo del <strong>Equipo Rojo</strong> (1 de 2)
            </div>

            <p id="equipoLabel" class="equipo-label equipo-rojo">üî¥ Dibujo del Equipo Rojo</p>

            <div class="comparacion">
                <div class="imagen-box original">
                    <h3>üì∑ Imagen Original</h3>
                    <img th:src="@{/resources/images/{img}(img=${imagenOriginal})}" alt="Imagen original">
                </div>
                <div class="imagen-box dibujo rojo" id="dibujoBox">
                    <h3>‚úèÔ∏è Dibujo del Equipo</h3>
                    <img id="dibujoActual" th:src="${dibujoRojo}" alt="Dibujo">
                </div>
            </div>

            <p>¬øQu√© tan bien representa la imagen original? (1-10)</p>

            <div class="votacion">
                <button class="btn-voto" onclick="votar(1)">1</button>
                <button class="btn-voto" onclick="votar(2)">2</button>
                <button class="btn-voto" onclick="votar(3)">3</button>
                <button class="btn-voto" onclick="votar(4)">4</button>
                <button class="btn-voto" onclick="votar(5)">5</button>
                <button class="btn-voto" onclick="votar(6)">6</button>
                <button class="btn-voto" onclick="votar(7)">7</button>
                <button class="btn-voto" onclick="votar(8)">8</button>
                <button class="btn-voto" onclick="votar(9)">9</button>
                <button class="btn-voto" onclick="votar(10)">10</button>
            </div>

            <div id="esperando" class="esperando" style="display: none;">
                ‚è≥ Esperando a que todos voten...
            </div>
        </div>

        <!-- Pantalla de resultado final -->
        <div id="pantallaResultado" class="resultado-final">
            <h1>üèÜ ¬°Resultados Finales!</h1>
            <div class="puntajes">
                <div class="puntaje-equipo rojo">
                    <p>üî¥ Equipo Rojo</p>
                    <p class="puntaje-numero" id="puntajeRojo">0</p>
                    <p>puntos</p>
                </div>
                <div class="puntaje-equipo azul">
                    <p>üîµ Equipo Azul</p>
                    <p class="puntaje-numero" id="puntajeAzul">0</p>
                    <p>puntos</p>
                </div>
            </div>
            <div id="ganadorBanner" class="ganador-banner rojo">üèÜ ¬°Ganador: Equipo Rojo!</div>
            <button class="btn-volver" onclick="volverAlLobby()">üéÆ Volver al Lobby</button>
        </div>
    </div>

    <script th:src="@{/webjars/stomp-websocket/2.3.3/stomp.min.js}"></script>

    <script th:inline="javascript">
        const miNombre = /*[[${username}]]*/ 'Jugador';
        const miSalaId = /*[[${salaId}]]*/ 'ABC123';
        const dibujoRojo = /*[[${dibujoRojo}]]*/ '';
        const dibujoAzul = /*[[${dibujoAzul}]]*/ '';

        let stompClient = null;
        let faseActual = 1;
        let miVoto = null;

        function conectar() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const contextPath = /*[[@{/}]]*/ '/';
            const wsUrl = protocol + '//' + host + contextPath + 'pinto-websocket';

            const socket = new WebSocket(wsUrl);
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, function () {
                stompClient.subscribe('/topic/votacion/' + miSalaId, function (mensaje) {
                    procesarMensaje(JSON.parse(mensaje.body));
                });
            });
        }

        function votar(puntaje) {
            if (miVoto !== null) return;
            miVoto = puntaje;

            document.querySelectorAll('.btn-voto').forEach((btn, i) => {
                if (i + 1 === puntaje) btn.classList.add('seleccionado');
                btn.disabled = true;
            });

            document.getElementById('esperando').style.display = 'block';

            if (stompClient && stompClient.connected) {
                stompClient.send('/app/votar/' + miSalaId, {}, JSON.stringify({
                    tipo: 'votar',
                    username: miNombre,
                    equipoVotado: faseActual === 1 ? 'rojo' : 'azul',
                    puntaje: puntaje
                }));
            }
        }

        function procesarMensaje(data) {
            if (data.tipo === 'siguiente_fase') {
                faseActual = 2;
                miVoto = null;

                document.getElementById('faseInfo').innerHTML = 'Votando el dibujo del <strong>Equipo Azul</strong> (2 de 2)';
                document.getElementById('equipoLabel').className = 'equipo-label equipo-azul';
                document.getElementById('equipoLabel').textContent = 'üîµ Dibujo del Equipo Azul';
                document.getElementById('dibujoActual').src = dibujoAzul;
                document.getElementById('dibujoBox').className = 'imagen-box dibujo azul';
                document.getElementById('esperando').style.display = 'none';

                document.querySelectorAll('.btn-voto').forEach(btn => {
                    btn.classList.remove('seleccionado');
                    btn.disabled = false;
                });
            }

            if (data.tipo === 'resultado_final') {
                document.getElementById('pantallaVotacion').style.display = 'none';
                document.getElementById('pantallaResultado').classList.add('visible');
                document.getElementById('puntajeRojo').textContent = data.puntajeRojo;
                document.getElementById('puntajeAzul').textContent = data.puntajeAzul;

                const banner = document.getElementById('ganadorBanner');
                if (data.ganador === 'rojo') {
                    banner.className = 'ganador-banner rojo';
                    banner.innerHTML = 'üèÜ ¬°Ganador: Equipo Rojo!';
                } else if (data.ganador === 'azul') {
                    banner.className = 'ganador-banner azul';
                    banner.innerHTML = 'üèÜ ¬°Ganador: Equipo Azul!';
                } else {
                    banner.className = 'ganador-banner empate';
                    banner.innerHTML = 'ü§ù ¬°Empate!';
                }
            }
        }

        function volverAlLobby() {
            window.location.href = /*[[@{/lobby}]]*/ '/lobby';
        }

        conectar();
    </script>
</body>

</html>