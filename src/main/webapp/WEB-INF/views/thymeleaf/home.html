<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pinto - Juego de Dibujo Online</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        #container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 15px;
        }

        #estado {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        #estado.conectado {
            background-color: #d4edda;
            color: #155724;
        }

        #estado.desconectado {
            background-color: #f8d7da;
            color: #721c24;
        }

        .info-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 14px;
        }

        .timer {
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            padding: 15px 30px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .timer.urgente {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            animation: pulso 0.5s infinite;
        }

        @keyframes pulso {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        .equipo-rojo {
            background: linear-gradient(135deg, #ffe0e0, #ffcccc);
            color: #c0392b;
            border: 2px solid #e74c3c;
        }

        .equipo-azul {
            background: linear-gradient(135deg, #e0e8ff, #ccd9ff);
            color: #2980b9;
            border: 2px solid #3498db;
        }

        .rol-observador {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            color: #155724;
            border: 2px solid #28a745;
        }

        .rol-dibujante {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            color: #856404;
            border: 2px solid #ffc107;
        }

        .game-area {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #canvas {
            display: block;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: crosshair;
        }

        /* Canvas negro para dibujante */
        #canvas.canvas-ciego {
            filter: brightness(0);
            cursor: crosshair;
        }

        .imagen-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            border: 3px dashed #28a745;
        }

        .imagen-container h3 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .imagen-referencia {
            max-width: 300px;
            max-height: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        #controles {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            justify-content: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .control-group label {
            font-weight: 500;
            color: #555;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #btnBorrar {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        #btnBorrar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(231, 76, 60, 0.4);
        }

        .mensaje-rol {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 16px;
        }

        .mensaje-observador {
            background: #d4edda;
            color: #155724;
            border: 2px solid #28a745;
        }

        .mensaje-dibujante {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffc107;
        }

        /* Historial de colores */
        #coloresRecientes {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .colorReciente {
            width: 28px;
            height: 28px;
            border: 3px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .colorReciente:hover {
            transform: scale(1.15);
            border-color: #999;
        }
    </style>
</head>

<body>
    <div id="container">
        <h1>üé® Pinto - Dibuj√° Online</h1>

        <div id="estado" class="desconectado">‚è≥ Conectando como <span th:text="${username}"></span>...</div>

        <div class="info-row">
            <span class="badge" th:classappend="'equipo-' + ${equipo}">
                <span th:text="${equipo == 'rojo'} ? 'üî¥ Equipo Rojo' : 'üîµ Equipo Azul'">Equipo</span>
            </span>
            <span class="badge" th:classappend="'rol-' + ${rol}">
                <span th:text="${rol == 'observador'} ? 'üëÅÔ∏è Observador' : '‚úèÔ∏è Dibujante'">Rol</span>
            </span>
        </div>

        <!-- Timer -->
        <div id="timer" class="timer">‚è±Ô∏è 01:00</div>

        <div class="game-area">
            <!-- Imagen de referencia: solo para OBSERVADOR -->
            <div th:if="${rol == 'observador'}" class="imagen-container">
                <h3>üì∑ Imagen a dibujar</h3>
                <img th:src="@{/resources/images/{img}(img=${imagen})}" alt="Imagen a dibujar"
                    class="imagen-referencia">
                <p style="margin-top: 10px; color: #666;">Tu compa√±ero debe dibujar esto</p>
            </div>

            <!-- Canvas -->
            <div class="canvas-container">
                <canvas id="canvas" width="600" height="400" style="background: white;"
                    th:classappend="${rol == 'dibujante'} ? 'canvas-ciego' : ''">
                </canvas>

                <!-- Mensaje seg√∫n rol -->
                <div th:if="${rol == 'observador'}" class="mensaje-rol mensaje-observador">
                    üëÅÔ∏è Est√°s observando. Ve lo que dibuja tu compa√±ero y adivina la imagen.
                </div>
                <div th:if="${rol == 'dibujante'}" class="mensaje-rol mensaje-dibujante">
                    ‚úèÔ∏è Dibuj√° la imagen que te describi√≥ tu compa√±ero. ¬°No pod√©s ver lo que dibuj√°s!
                </div>
            </div>
        </div>

        <!-- Controles: solo para DIBUJANTE -->
        <div th:if="${rol == 'dibujante'}" id="controles">
            <div class="control-group">
                <label>Grosor:</label>
                <input type="range" id="grosor" min="1" max="30" value="5">
                <span id="valorGrosor">5</span>
            </div>

            <div class="control-group">
                <label>Color:</label>
                <input type="color" id="color" value="#000000">
            </div>

            <div class="control-group">
                <label>Recientes:</label>
                <div id="coloresRecientes"></div>
            </div>

            <button id="btnBorrar">üóëÔ∏è Borrar todo</button>
        </div>
    </div>

    <!-- STOMP para WebSocket -->
    <script th:src="@{/webjars/stomp-websocket/2.3.3/stomp.min.js}"></script>

    <script th:inline="javascript">
        // =====================
        // CONFIGURACI√ìN
        // =====================
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const estadoDiv = document.getElementById('estado');

        // Variables del servidor
        let miNombre = /*[[${username}]]*/ 'Jugador';
        let miEquipo = /*[[${equipo}]]*/ 'rojo';
        let miSalaId = /*[[${salaId}]]*/ 'ABC123';
        let miRol = /*[[${rol}]]*/ 'observador';

        // Solo dibujante tiene controles
        const inputGrosor = document.getElementById('grosor');
        const inputColor = document.getElementById('color');
        const btnBorrar = document.getElementById('btnBorrar');
        const coloresRecientesDiv = document.getElementById('coloresRecientes');
        const spanGrosor = document.getElementById('valorGrosor');

        let dibujando = false;
        let coloresRecientes = [];
        const MAX_COLORES_RECIENTES = 8;
        let stompClient = null;

        // Posici√≥n del cursor remoto (para el observador)
        let cursorRemoto = { x: 0, y: 0, visible: false };

        // =====================
        // WEBSOCKET
        // =====================
        function conectarWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const host = window.location.host;
            const contextPath = /*[[@{/}]]*/ '/';
            const wsUrl = protocol + '//' + host + contextPath + 'pinto-websocket';

            console.log('Conectando a WebSocket:', wsUrl);

            const socket = new WebSocket(wsUrl);
            stompClient = Stomp.over(socket);
            stompClient.debug = null;

            stompClient.connect({}, function (frame) {
                console.log('Conectado: ' + frame);
                estadoDiv.innerHTML = '‚úÖ Conectado como <strong>' + miNombre + '</strong>';
                estadoDiv.className = 'conectado';

                // Suscribirse al canal de trazos DEL MISMO EQUIPO
                stompClient.subscribe('/topic/trazos/' + miSalaId + '/' + miEquipo, function (mensaje) {
                    const trazo = JSON.parse(mensaje.body);

                    // Solo dibujar si es de otro jugador
                    if (trazo.jugador !== miNombre) {
                        procesarTrazoRecibido(trazo);
                    }
                });
            }, function (error) {
                console.error('Error WebSocket:', error);
                estadoDiv.textContent = '‚ùå Desconectado - Reintentando...';
                estadoDiv.className = 'desconectado';
                setTimeout(conectarWebSocket, 3000);
            });
        }

        // Estado de trazos remotos
        let trazosRemotos = {};

        function procesarTrazoRecibido(trazo) {
            if (trazo.tipo === 'cursor') {
                // Actualizar posici√≥n del cursor remoto
                cursorRemoto = { x: trazo.x, y: trazo.y, visible: true };
                dibujarCursorRemoto();
                return;
            }

            if (trazo.tipo === 'borrar') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            if (!trazosRemotos[trazo.jugador]) {
                trazosRemotos[trazo.jugador] = { x: 0, y: 0 };
            }

            if (trazo.tipo === 'inicio') {
                trazosRemotos[trazo.jugador] = { x: trazo.x, y: trazo.y };
            } else if (trazo.tipo === 'dibujo') {
                ctx.save();
                ctx.strokeStyle = trazo.color;
                ctx.lineWidth = trazo.grosor;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.beginPath();
                ctx.moveTo(trazosRemotos[trazo.jugador].x, trazosRemotos[trazo.jugador].y);
                ctx.lineTo(trazo.x, trazo.y);
                ctx.stroke();
                ctx.restore();
                trazosRemotos[trazo.jugador] = { x: trazo.x, y: trazo.y };
            }
        }

        // Enviar trazo (solo si es dibujante)
        function enviarTrazo(tipo, x, y) {
            if (miRol !== 'dibujante') return;

            if (stompClient && stompClient.connected) {
                const trazo = {
                    tipo: tipo,
                    x: x,
                    y: y,
                    color: inputColor ? inputColor.value : '#000000',
                    grosor: inputGrosor ? parseInt(inputGrosor.value) : 5,
                    jugador: miNombre
                };
                stompClient.send('/app/dibujar/' + miSalaId + '/' + miEquipo, {}, JSON.stringify(trazo));
            }
        }

        // Enviar posici√≥n del cursor (solo dibujante, para que observador vea)
        function enviarCursor(x, y) {
            if (miRol !== 'dibujante') return;

            if (stompClient && stompClient.connected) {
                const cursor = {
                    tipo: 'cursor',
                    x: x,
                    y: y,
                    jugador: miNombre
                };
                stompClient.send('/app/dibujar/' + miSalaId + '/' + miEquipo, {}, JSON.stringify(cursor));
            }
        }

        // Dibujar indicador del cursor remoto (solo para observador)
        // Usamos un overlay para no interferir con el dibujo
        let cursorOverlay = null;

        function dibujarCursorRemoto() {
            if (miRol !== 'observador') return;

            // Crear overlay si no existe
            if (!cursorOverlay) {
                cursorOverlay = document.createElement('div');
                cursorOverlay.style.cssText = `
                    position: absolute;
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid #e74c3c;
                    background: rgba(231, 76, 60, 0.3);
                    pointer-events: none;
                    transform: translate(-50%, -50%);
                    z-index: 100;
                    transition: all 0.05s ease-out;
                `;
                canvas.parentElement.style.position = 'relative';
                canvas.parentElement.appendChild(cursorOverlay);
            }

            // Posicionar el cursor
            const rect = canvas.getBoundingClientRect();
            cursorOverlay.style.left = cursorRemoto.x + 'px';
            cursorOverlay.style.top = cursorRemoto.y + 'px';
            cursorOverlay.style.display = cursorRemoto.visible ? 'block' : 'none';
        }

        // =====================
        // EVENTOS DEL CANVAS - Solo DIBUJANTE puede dibujar
        // =====================
        if (miRol === 'dibujante') {
            canvas.addEventListener('mousedown', (e) => {
                dibujando = true;
                ctx.lineWidth = inputGrosor.value;
                ctx.lineCap = 'round';
                ctx.strokeStyle = inputColor.value;
                ctx.beginPath();
                ctx.moveTo(e.offsetX, e.offsetY);
                enviarTrazo('inicio', e.offsetX, e.offsetY);
                agregarColorReciente(inputColor.value);
            });

            canvas.addEventListener('mousemove', (e) => {
                // Siempre enviar posici√≥n del cursor
                enviarCursor(e.offsetX, e.offsetY);

                if (dibujando) {
                    ctx.lineTo(e.offsetX, e.offsetY);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(e.offsetX, e.offsetY);
                    enviarTrazo('dibujo', e.offsetX, e.offsetY);
                }
            });

            canvas.addEventListener('mouseup', () => {
                dibujando = false;
                enviarTrazo('fin', 0, 0);
            });

            canvas.addEventListener('mouseleave', () => {
                dibujando = false;
            });

            // Touch events
            function getTouchPos(touch) {
                const rect = canvas.getBoundingClientRect();
                return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
            }

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const pos = getTouchPos(e.touches[0]);
                dibujando = true;
                ctx.lineWidth = inputGrosor.value;
                ctx.lineCap = 'round';
                ctx.strokeStyle = inputColor.value;
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
                enviarTrazo('inicio', pos.x, pos.y);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (dibujando) {
                    const pos = getTouchPos(e.touches[0]);
                    ctx.lineTo(pos.x, pos.y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(pos.x, pos.y);
                    enviarTrazo('dibujo', pos.x, pos.y);
                }
            });

            canvas.addEventListener('touchend', () => {
                dibujando = false;
            });
        }

        // =====================
        // CONTROLES (solo DIBUJANTE)
        // =====================
        if (inputGrosor) {
            inputGrosor.addEventListener('input', () => {
                spanGrosor.textContent = inputGrosor.value;
            });
        }

        if (btnBorrar) {
            btnBorrar.addEventListener('click', () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if (stompClient && stompClient.connected) {
                    const mensaje = { tipo: 'borrar', jugador: miNombre };
                    stompClient.send('/app/borrar/' + miSalaId + '/' + miEquipo, {}, JSON.stringify(mensaje));
                }
            });
        }

        if (inputColor) {
            inputColor.addEventListener('change', () => {
                agregarColorReciente(inputColor.value);
            });
        }

        // =====================
        // COLORES RECIENTES
        // =====================
        function agregarColorReciente(color) {
            if (!coloresRecientesDiv) return;
            const index = coloresRecientes.indexOf(color);
            if (index > -1) coloresRecientes.splice(index, 1);
            coloresRecientes.unshift(color);
            if (coloresRecientes.length > MAX_COLORES_RECIENTES) coloresRecientes.pop();
            actualizarColoresRecientes();
        }

        function actualizarColoresRecientes() {
            if (!coloresRecientesDiv) return;
            coloresRecientesDiv.innerHTML = '';
            coloresRecientes.forEach(color => {
                const div = document.createElement('div');
                div.className = 'colorReciente';
                div.style.backgroundColor = color;
                div.title = color;
                div.addEventListener('click', () => {
                    inputColor.value = color;
                });
                coloresRecientesDiv.appendChild(div);
            });
        }

        // =====================
        // TIMER
        // =====================
        const timerDiv = document.getElementById('timer');
        let tiempoRestante = 300; // 5 minutos

        function actualizarTimer() {
            const minutos = Math.floor(tiempoRestante / 60);
            const segundos = tiempoRestante % 60;
            timerDiv.textContent = '‚è±Ô∏è ' +
                String(minutos).padStart(2, '0') + ':' +
                String(segundos).padStart(2, '0');

            // Agregar efecto urgente en √∫ltimos 10 segundos
            if (tiempoRestante <= 10) {
                timerDiv.classList.add('urgente');
            }

            if (tiempoRestante <= 0) {
                timerDiv.textContent = '‚è±Ô∏è ¬°Tiempo!';
                finalizarDibujo();
            } else {
                tiempoRestante--;
                setTimeout(actualizarTimer, 1000);
            }
        }

        function finalizarDibujo() {
            // Capturar el canvas como imagen base64
            const dibujoBase64 = canvas.toDataURL('image/png');

            // Enviar al servidor
            fetch(/*[[@{/guardar-dibujo}]]*/ '/guardar-dibujo', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    salaId: miSalaId,
                    equipo: miEquipo,
                    dibujo: dibujoBase64
                })
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Dibujo guardado:', data);
                    // Redirigir a resultados
                    setTimeout(() => {
                        window.location.href = /*[[@{/resultado}]]*/ '/resultado';
                    }, 1500);
                })
                .catch(error => {
                    console.error('Error guardando dibujo:', error);
                    window.location.href = /*[[@{/resultado}]]*/ '/resultado';
                });
        }

        // =====================
        // INICIAR
        // =====================
        conectarWebSocket();
        actualizarTimer(); // Iniciar timer
    </script>
</body>

</html>